import sys, os

SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
sys.path.append(os.path.dirname(SCRIPT_DIR))

import unittest
import numpy as np

from classification.hierarchical import DIANA
from classification.statistics import diana_misclassified_number

class TestHierarchical(unittest.TestCase):

    def test_DIANA_1D_8(self):
        print("test DIANAN with 8 1D data")
        data = np.array([-0.308, -0.179, 0.21, 0.421, 1.224, 1.579, 1.681, 1.717]).reshape((8,1))

        label, n_cluster = DIANA(data)
        print("label.shape:", label.shape, "label: ", label,  "number of clsuter: ", n_cluster)
        """label:  [[-0.308  7.   ]
                    [-0.179  2.   ]
                    [ 0.21   5.   ]
                    [ 0.421  3.   ]
                    [ 1.224  4.   ]
                    [ 1.579  6.   ]
                    [ 1.681  8.   ]
                    [ 1.717  1.   ]]"""
        # in matlab: [label] = DIANA(data)
        tlabels = np.array([7, 2, 5, 3, 4, 6, 8, 1])
        mis_cnt, _ = diana_misclassified_number(tlabels, label[:, -1])
        self.assertEqual(mis_cnt, 0)


    def test_DIANA_1D_100(self):
        print("test DIANAN with 100 1D data")

        data = np.array([3.5482, 4.6674, 1.0473, 5.6033, 5.6490, 1.0925, 0.3819, 0.8112, 2.0446, 3.7192, 4.2621, 0.0731, 2.2258, 4.5303, 2.3143, 0.9975, 0.9722, 1.4315, 4.6841, 4.8504, 2.9010, 1.6335, 1.9157, 1.6529, -0.2038, 0.6658, 2.0319, -0.5749, -0.1906, 4.6679, 0.5349, 4.0272, 3.8681, 4.8752, 4.9546, 3.9890, 0.5597, 4.0140, 0.7547, 4.2132, 1.0648, 1.5390, 3.1220, -0.0477, 0.1182, 0.3313, -0.0898, 5.0785, 3.3443, 0.8612, 0.2484, 3.6467, -0.4374, 2.4506, 4.0768, 2.7571, 3.6698, 1.8691, 3.5788, 1.8352, 1.4595, 0.1218, 3.6750, 3.6409, 4.6677, 4.0031, 3.2051, 2.3210, 4.4926, 5.3318, 0.7190, 2.4701, 0.3329, -0.4553, 2.9369, 4.1644, 0.5980, 3.2978, 3.2826, -0.5850, 6.2510, 0.2329, 0.1905, 3.6193, 1.2126, 0.0313, 0.7242, 4.0315, 2.3847, 2.6081, 4.3528, 6.2919, 4.8995, 4.4961, 4.9107, 1.9365, 2.8679, 0.8526, 4.1107, -0.0296,]).reshape((100, 1))

        label, n_cluster = DIANA(data)
        print("label.shape:", label.shape, "label: ", label, "number of clsuter: ", n_cluster)
        # in matlab: [label] = DIANA(data)
        tlabels = np.array([69, 99, 81, 59, 12, 60, 21, 57, 87, 47, 48, 62, 35, 64, 91, 72, 43, 70, 82, 73, 68, 77, 75, 16, 86, 40, 30, 89, 18, 100, 74, 95, 23, 53, 45, 85, 19, 80, 65, 58, 24, 44, 15, 78, 96, 98, 54,  7, 52, 90, 83, 92, 79, 76, 67, 31, 94, 66, 33, 46, 28, 10,  4, 56,  9, 61, 39, 13, 97, 25, 93, 20, 29, 37, 50, 27, 51, 84,  8,  3, 63, 41, 55, 71, 11, 34,  1, 14, 49, 36, 32,  2, 88, 17, 26,  6,  5, 38, 42, 22])
        
        mis_cnt, _ = diana_misclassified_number(tlabels, label[:, -1])
        self.assertEqual(mis_cnt, 0)

    def test_DIANA_2D_100(self):
        print("test DIANAN with 100 2D data")
        data = np.array([[1.0908, 0.2894], [2.2991, 3.6485], [2.5934, 5.4505], [1.1632, 1.6596], [0.9466, -0.7360], [1.2054, 0.7978], [3.6348, 4.1629], [2.9563, 4.5428], [4.6725, 3.8615], [2.4276, 0.4553], [0.3472, 1.9508], [0.6830, 2.6983], [4.8593, 4.0894], [1.2683, 2.0437], [3.2508, 3.2661], [4.4164, 2.6229], [1.2119, 2.5480], [3.7974, 3.3708], [3.2405, 4.1045], [3.2168, 3.4492], [3.8448, 6.4812], [3.4729, 4.6836], [-1.7417, -1.3826], [4.7463, 4.8391], [3.3499, 3.9292], [-0.1083, -0.0999], [0.1107, 3.3254], [4.9015, 3.4347], [4.5196, 4.1858], [3.8471, 3.7286], [3.0700, 2.0664], [0.7684, 1.3149], [1.0654, 2.1259], [4.2176, 4.1642], [1.4764, 0.8993], [2.2495, 0.8417], [0.5755, -0.7325], [1.8702, 3.1997], [-0.3172, 1.2089], [4.0299, 3.9867], [5.1867, 2.5643], [2.6177, 1.8295], [4.3929, 3.8827], [3.9746, 3.8916], [3.4109, 4.7330], [1.8530, 0.3852], [3.2161, 4.8263], [1.2614, 0.5442], [2.7628, 1.2396], [3.2382, 6.3681], [4.2738, 4.8909], [0.5717, 0.6846], [0.5671, 1.0730], [3.7795, 3.6815], [-0.6641, 0.4760], [2.1305, 1.3846], [2.9787, 4.1951], [3.9804, 3.7318], [0.1516, 2.4687], [1.9569, 0.5859], [1.4925, -0.1924], [0.3986, 0.5474], [4.6874, 5.9676], [1.2923, 2.5975], [1.9123, 1.0726], [0.1386, 2.5929], [-0.1881, 0.4515], [3.8684, 4.1645], [3.1039, 3.0067], [4.6681, 2.7472], [1.1911, 1.6443], [1.2889, 0.6344], [0.4602, 0.5527], [5.3251, 3.8831], [2.7125, 1.0870], [0.8716, 0.1523], [0.9660, -0.5726], [3.2994, 2.9291], [4.3538, 4.0200], [-0.1409, 2.1295], [5.9160, 4.7556], [3.7950, 2.1445], [2.9782, 0.4112], [0.4173, 2.5145], [3.0004, -0.0709], [0.8923, -0.1464], [1.0014, -0.4828], [4.5340, 4.0500], [2.8601, 3.7910], [4.5940, 4.5938], [0.0989, 1.3197], [1.2610, 2.5079], [0.4306, 0.6049], [5.0821, 3.3541], [4.0327, 5.0711], [3.6979, 5.0649], [4.3587, 3.9390], [2.1878, 3.0217], [3.7223, 6.1014], [5.3108, 2.2086]]).reshape((100, 2))

        label, n_cluster = DIANA(data)
        print("label.shape:", label.shape, "label: ", label, "number of clsuter: ", n_cluster)

        # in matlab: [label] = DIANA(data)
        tlabels = np.array([78, 15,  9, 100, 77, 76, 46, 69, 48, 44, 30, 60, 42, 81, 85, 75, 98, 41, 84, 23, 68, 95,  2, 22, 29, 52,  5, 21, 88, 94, 40, 43, 20, 70, 45, 63, 64,  8, 53, 90, 37, 54, 96, 65, 28, 79, 58, 93, 86, 61, 72, 80, 47, 49, 24, 25, 31, 83, 89, 38, 12, 97, 34, 92, 56, 33, 17, 73, 82, 18, 27, 50, 99, 62,  7, 55, 91, 19, 87, 57, 13, 14, 66, 74, 26, 35, 10, 71, 59, 36, 39, 16,  4, 32, 51, 67,  1, 11,  3,  6])
        
        mis_cnt, _ = diana_misclassified_number(tlabels, label[:, -1])
        self.assertEqual(mis_cnt, 0)

    def test_DIANA_from_file(self):
        fn = r"/Users/elexu/Downloads/raster.csv"
        data = np.genfromtxt(fn, delimiter=",")
        print("test DIANA with ", data.shape)
        n_cluster = 3
        label, n_cluster = DIANA(data, n_cluster)
        print("result: ", label.shape, n_cluster)


if __name__ == '__main__':
    unittest.main()
